2025-06-25 23:13:28,251 - root - INFO - === Testing with Real Data ===
2025-06-25 23:13:28,252 - root - INFO - Starting agent classification test...
2025-06-25 23:13:28,254 - root - INFO - Loading data...
2025-06-25 23:13:28,254 - src.credit_health_engine - INFO - Loading and validating input data...
2025-06-25 23:13:28,254 - src.credit_health_engine - INFO - Loading credit_Agents.xlsx...
2025-06-25 23:13:28,586 - src.credit_health_engine - INFO - Loaded 1915 rows from credit_Agents.xlsx
2025-06-25 23:13:28,590 - src.credit_health_engine - INFO - [OK] Successfully loaded credit_Agents.xlsx with shape (1915, 7)
2025-06-25 23:13:28,590 - src.credit_health_engine - INFO - Loading Credit_history_sales_vs_credit_sales.xlsx...
2025-06-25 23:13:28,717 - src.credit_health_engine - WARNING - Could not convert 'Account' to int64 directly: Cannot convert non-finite values (NA or inf) to integer
2025-06-25 23:13:28,720 - src.credit_health_engine - INFO - Successfully cleaned 'Account' column
2025-06-25 23:13:28,723 - src.credit_health_engine - INFO - Found complete data for: total_gmv, credit_gmv
2025-06-25 23:13:28,723 - src.credit_health_engine - INFO - Loaded 1413 rows from Credit_history_sales_vs_credit_sales.xlsx
2025-06-25 23:13:28,727 - src.credit_health_engine - INFO - [OK] Successfully loaded Credit_history_sales_vs_credit_sales.xlsx with shape (1413, 19)
2025-06-25 23:13:28,727 - src.credit_health_engine - INFO - Loading Credit_sales_data.xlsx...
2025-06-25 23:13:29,018 - src.credit_health_engine - INFO - Loaded 6226 rows from Credit_sales_data.xlsx
2025-06-25 23:13:29,020 - src.credit_health_engine - INFO - [OK] Successfully loaded Credit_sales_data.xlsx with shape (6226, 4)
2025-06-25 23:13:29,020 - src.credit_health_engine - INFO - Loading DPD.xlsx...
2025-06-25 23:13:29,031 - src.credit_health_engine - INFO - Loaded 91 rows from DPD.xlsx
2025-06-25 23:13:29,034 - src.credit_health_engine - INFO - [OK] Successfully loaded DPD.xlsx with shape (91, 7)
2025-06-25 23:13:29,035 - src.credit_health_engine - INFO - Loading Region_contact.xlsx...
2025-06-25 23:13:29,043 - src.credit_health_engine - INFO - Loaded 9 rows from Region_contact.xlsx
2025-06-25 23:13:29,045 - src.credit_health_engine - INFO - [OK] Successfully loaded Region_contact.xlsx with shape (9, 3)
2025-06-25 23:13:29,045 - src.credit_health_engine - INFO - Loading sales_data.xlsx...
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - Loaded 13913 rows from sales_data.xlsx
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - [OK] Successfully loaded sales_data.xlsx with shape (13913, 13)
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - 
==================================================
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - DATA LOADING SUMMARY
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - ==================================================
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO - 
[OK] Successfully loaded files:
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO -   - Credit_history_sales_vs_credit_sales.xlsx: 1413 rows
2025-06-25 23:13:29,935 - src.credit_health_engine - INFO -   - Credit_sales_data.xlsx: 6226 rows
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO -   - DPD.xlsx: 91 rows
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO -   - Region_contact.xlsx: 9 rows
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO -   - credit_Agents.xlsx: 1915 rows
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO -   - sales_data.xlsx: 13913 rows
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO - 
✅ All files loaded and validated successfully!
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO - ==================================================

2025-06-25 23:13:29,940 - root - INFO - Engineering features...
2025-06-25 23:13:29,940 - src.credit_health_engine - INFO - Engineering features...
2025-06-25 23:13:29,941 - src.feature_engineering - INFO - Engineering all features...
2025-06-25 23:13:29,941 - src.feature_engineering - INFO - Calculating credit utilization...
2025-06-25 23:13:29,944 - src.feature_engineering - INFO - Added feature: credit_utilization
2025-06-25 23:13:29,944 - src.feature_engineering - INFO - Calculating comprehensive repayment scores...
2025-06-25 23:13:29,981 - src.feature_engineering - INFO - Calculated repayment scores for 1915 agents
2025-06-25 23:13:29,981 - src.feature_engineering - INFO - Added feature: repayment_score
2025-06-25 23:13:29,982 - src.feature_engineering - INFO - Calculating credit GMV share...
2025-06-25 23:13:29,982 - src.feature_engineering - ERROR - Missing required columns in credit sales data
2025-06-25 23:13:29,983 - src.feature_engineering - WARNING - Could not calculate feature: credit_gmv_share
2025-06-25 23:13:29,983 - src.feature_engineering - INFO - Calculating GMV trends (total: 6m, credit: 5m)...
2025-06-25 23:13:29,984 - src.feature_engineering - ERROR - Missing columns in total data: Bzid, SaleDate, TotalSales
2025-06-25 23:13:29,985 - src.feature_engineering - WARNING - No credit sales data available
2025-06-25 23:13:29,985 - src.feature_engineering - INFO - Calculated GMV trends for 0 agents
2025-06-25 23:13:29,986 - src.feature_engineering - WARNING - Could not calculate feature: gmv_trend_6m
2025-06-25 23:13:29,986 - src.feature_engineering - INFO - Calculating comprehensive recovery metrics...
2025-06-25 23:13:29,988 - src.feature_engineering - INFO - Calculated recovery metrics for 91 agents
2025-06-25 23:13:29,988 - src.feature_engineering - INFO - Added feature: recovery_index
2025-06-25 23:13:29,988 - src.feature_engineering - INFO - Calculating delinquency flags and DPD trends...
2025-06-25 23:13:29,988 - src.feature_engineering - ERROR - Required columns not found in DPD data: ['DueDate']
2025-06-25 23:13:29,989 - src.feature_engineering - WARNING - Using default values for delinquency flags
2025-06-25 23:13:29,990 - src.feature_engineering - INFO - Calculating region risk...
2025-06-25 23:13:29,990 - src.feature_engineering - ERROR - Required data or columns not found for region risk calculation
2025-06-25 23:13:29,991 - src.feature_engineering - INFO - Feature engineering complete. Created 6 features.
2025-06-25 23:13:29,991 - src.credit_health_engine - INFO - Successfully engineered 6 features for 1915 agents
2025-06-25 23:13:29,997 - src.credit_health_engine - INFO - Features saved to output\features/engineered_features.csv
2025-06-25 23:13:29,997 - root - INFO - Classifying agents...
2025-06-25 23:13:29,997 - src.credit_health_engine - INFO - Classifying agents into tiers...
2025-06-25 23:13:30,009 - src.agent_classifier - INFO - Classified 100/1915 agents
2025-06-25 23:13:30,019 - src.agent_classifier - INFO - Classified 200/1915 agents
2025-06-25 23:13:30,028 - src.agent_classifier - INFO - Classified 300/1915 agents
2025-06-25 23:13:30,045 - src.agent_classifier - INFO - Classified 400/1915 agents
2025-06-25 23:13:30,058 - src.agent_classifier - INFO - Classified 500/1915 agents
2025-06-25 23:13:30,070 - src.agent_classifier - INFO - Classified 600/1915 agents
2025-06-25 23:13:30,091 - src.agent_classifier - INFO - Classified 700/1915 agents
2025-06-25 23:13:30,104 - src.agent_classifier - INFO - Classified 800/1915 agents
2025-06-25 23:13:30,116 - src.agent_classifier - INFO - Classified 900/1915 agents
2025-06-25 23:13:30,127 - src.agent_classifier - INFO - Classified 1000/1915 agents
2025-06-25 23:13:30,138 - src.agent_classifier - INFO - Classified 1100/1915 agents
2025-06-25 23:13:30,154 - src.agent_classifier - INFO - Classified 1200/1915 agents
2025-06-25 23:13:30,166 - src.agent_classifier - INFO - Classified 1300/1915 agents
2025-06-25 23:13:30,179 - src.agent_classifier - INFO - Classified 1400/1915 agents
2025-06-25 23:13:30,190 - src.agent_classifier - INFO - Classified 1500/1915 agents
2025-06-25 23:13:30,199 - src.agent_classifier - INFO - Classified 1600/1915 agents
2025-06-25 23:13:30,210 - src.agent_classifier - INFO - Classified 1700/1915 agents
2025-06-25 23:13:30,220 - src.agent_classifier - INFO - Classified 1800/1915 agents
2025-06-25 23:13:30,232 - src.agent_classifier - INFO - Classified 1900/1915 agents
2025-06-25 23:13:30,236 - src.agent_classifier - INFO - Classification complete. Tier distribution:
tier
P0    1911
P1       2
P4       2
Name: count, dtype: int64
2025-06-25 23:13:30,236 - src.credit_health_engine - INFO - Successfully classified 1915 agents
2025-06-25 23:13:30,236 - src.credit_health_engine - ERROR - Error during agent classification: [Errno 13] Permission denied: 'output\\classifications\\agent_classifications.csv'
Traceback (most recent call last):
  File "D:\projects\Credit Risk\src\credit_health_engine.py", line 451, in classify_agents
    self.classified_agents.to_csv(output_file)
  File "C:\Users\aswin\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\LocalCache\local-packages\Python312\site-packages\pandas\util\_decorators.py", line 333, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\aswin\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\LocalCache\local-packages\Python312\site-packages\pandas\core\generic.py", line 3986, in to_csv
    return DataFrameRenderer(formatter).to_csv(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\aswin\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\LocalCache\local-packages\Python312\site-packages\pandas\io\formats\format.py", line 1014, in to_csv
    csv_formatter.save()
  File "C:\Users\aswin\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\LocalCache\local-packages\Python312\site-packages\pandas\io\formats\csvs.py", line 251, in save
    with get_handle(
         ^^^^^^^^^^^
  File "C:\Users\aswin\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\LocalCache\local-packages\Python312\site-packages\pandas\io\common.py", line 873, in get_handle
    handle = open(
             ^^^^^
PermissionError: [Errno 13] Permission denied: 'output\\classifications\\agent_classifications.csv'
2025-06-25 23:13:30,240 - root - ERROR - Agent classification failed
2025-06-25 23:13:30,241 - root - INFO - 
=== Testing with Sample Data ===
2025-06-25 23:13:30,241 - root - INFO - 
Testing AgentClassifier with sample data...
2025-06-25 23:13:30,242 - root - INFO - 
Sample 1:
2025-06-25 23:13:30,242 - root - INFO - Features: {'credit_utilization': 0.9, 'repayment_score': 95, 'gmv_trend_6m': 0.2, 'credit_gmv_share': 0.8, 'delinquent_30p': nan}
2025-06-25 23:13:30,242 - root - INFO - Classification: Tier P2 - Maxed limit + late payments
2025-06-25 23:13:30,242 - root - INFO - Recommended Action: Monitor / intervene
2025-06-25 23:13:30,242 - root - INFO - 
Sample 2:
2025-06-25 23:13:30,242 - root - INFO - Features: {'credit_utilization': 0.6, 'repayment_score': 75, 'gmv_trend_6m': -0.1, 'credit_gmv_share': 0.5, 'delinquent_30p': True}
2025-06-25 23:13:30,242 - root - INFO - Classification: Tier P1 - Usage decline or slight delays
2025-06-25 23:13:30,243 - root - INFO - Recommended Action: Follow-up
2025-06-25 23:13:30,243 - root - INFO - 
Sample 3:
2025-06-25 23:13:30,243 - root - INFO - Features: {'credit_utilization': 0.95, 'repayment_score': 60, 'gmv_trend_6m': 0.0, 'credit_gmv_share': 0.9, 'delinquent_30p': True}
2025-06-25 23:13:30,243 - root - INFO - Classification: Tier P2 - Maxed limit + late payments
2025-06-25 23:13:30,243 - root - INFO - Recommended Action: Monitor / intervene
2025-06-25 23:13:30,244 - root - INFO - 
Sample 4:
2025-06-25 23:13:30,244 - root - INFO - Features: {'credit_utilization': 0.3, 'repayment_score': 85, 'gmv_trend_6m': -0.3, 'credit_gmv_share': 0.4, 'delinquent_30p': nan}
2025-06-25 23:13:30,244 - root - INFO - Classification: Tier P1 - Usage decline or slight delays
2025-06-25 23:13:30,244 - root - INFO - Recommended Action: Follow-up
2025-06-25 23:13:30,244 - root - INFO - 
Sample 5:
2025-06-25 23:13:30,244 - root - INFO - Features: {'credit_utilization': 0.05, 'repayment_score': 100, 'gmv_trend_6m': 0.0, 'credit_gmv_share': 0.05, 'delinquent_30p': nan}
2025-06-25 23:13:30,244 - root - INFO - Classification: Tier P4 - Credit available but not used
2025-06-25 23:13:30,245 - root - INFO - Recommended Action: Educate / activate
2025-06-25 23:13:30,245 - root - INFO - 
Sample 6:
2025-06-25 23:13:30,245 - root - INFO - Features: {'credit_utilization': 0.0, 'repayment_score': 0, 'gmv_trend_6m': 0.0, 'credit_gmv_share': 0.0, 'delinquent_30p': nan}
2025-06-25 23:13:30,245 - root - INFO - Classification: Tier P5 - No use or repayment for a long time
2025-06-25 23:13:30,245 - root - INFO - Recommended Action: Churned — deprioritize
2025-06-25 23:13:30,245 - root - ERROR - 
❌ Some tests failed. Check the logs for details.
